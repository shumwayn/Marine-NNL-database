---
title: "GLM NNL Database"
author: "Nicole Shumway"
date: "19 August 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Load packages
```{r setup}


library(Hmisc)
library(MASS)
library(AER)
library(ggplot2)
library(tidyverse)
library(RColorBrewer)
library(effects)
library(ggrepel)
library(extrafont)

```


##Load Data
```{r }

Policy_Analysis <- read.csv("C:/Users/uqnshumw/OneDrive - The University of Queensland/Documents/Git/Marine-NNL-database/Policy_Analysis.csv")


#WGI_analysis <- read.csv("C:/Users/uqnshumw/OneDrive - The University of Queensland/PhD Research/Ch. 1a Marine NNL Policy Review/WGI_analysis.csv")
#View(WGI_Analysis)

```


#Correlation Matrix - ALL DATA

```{r}

head(Policy_Analysis)
Policy_data <- Policy_Analysis[,11:length(Policy_Analysis)] ## makes a new dataframe from policy analysis, subsets everything to the right of presence/absence
View(Policy_data)


round(cor(Policy_data, use = "na.or.complete"),2) ##rounds the date two decimal places for clarity
cor_matrix <- cor(Policy_data, use="pairwise.complete.obs", method = c("spearman"))   
View(cor_matrix)



```





#Ordinal Logistic Regression for ALL Policies
```{r}

#To describe or predict variables. OLR can id which variables predict the level of involvement in offsets policy

#Dividing data into training and test set
#Random sampling
#samplesize = .60*nrow(Policy_data)
#index = sample(seq_len(nrow(Policy_data)), size = samplesize)
#Creating training and test set 
#datatrain <- Policy_Analysis[index,]
#datatest <- Policy_Analysis[-index,]



## Build ordinal logistic regression model

### Stage of Policy vs. ALL values ###


Policy_Analysis$STAGE2 = factor(Policy_Analysis$STAGE2, levels = c("0", "1", "2", "3", "4") )

All_Stage <- polr(Policy_Analysis$STAGE2 ~  Policy_Analysis$mam_bird +Policy_Analysis$EEZ_Protected +
                      Policy_Analysis$OHI + log(Policy_Analysis$GDP) + 
                      Policy_Analysis$Polity2 + Policy_Analysis$Richness, data = Policy_Analysis, Hess = TRUE) ##DRopped Richness and NRR not significant
summary(All_Stage) 
coeftest(All_Stage)

#confidence intervals
ci_All <- confint(All_Stage)


#After building the model and interpreting the model, the next step is to evaluate it. 
  #The evaluation of the model is conducted on the test dataset. A basic evaluation approach is to compute the confusion matrix and the misclassification error. 

#Compute confusion table and misclassification error - model predicts 0,1 bette
predictstage = predict(All_Stage,Policy_Analysis)
table(Policy_Analysis$STAGE2, predictstage)
mean(as.character(Policy_Analysis$STAGE2) != 
       as.character(predictstage))


```


#Ordinal Logistic regression for marine policies
```{r}

```



#Testing for multicollinearity  
```{r} 

#https://cran.r-project.org/web/packages/olsrr/vignettes/regression_diagnostics.html

library(olsrr)

multico_model <- lm(Policy_Analysis$STAGE2 ~  Policy_Analysis$mam_bird +Policy_Analysis$EEZ_Protected +
                      Policy_Analysis$OHI + log(Policy_Analysis$GDP) + 
                      Policy_Analysis$Polity2 + Policy_Analysis$Richness, data = Policy_Analysis)

ols_vif_tol(multico_model)
View(multico_model)


ols_eigen_cindex(multico_model)

ols_coll_diag(multico_model)


```



##Stage of Policy vs Poltical values
```{r}


#For predicting
#Dividing data into training and test set
#Random sampling
##samplesize = .60*nrow(Policy_Analysis)
##index = sample(seq_len(nrow(Policy_Analysis)), size = samplesize)
#Creating training and test set 
##datatrain <- Policy_Analysis[index,]
##datatest <- Policy_Analysis[-index,]

Policy_Analysis$STAGE2 = factor(Policy_Analysis$STAGE2, levels = c("0", "1", "2", "3", "4") )

Policy_Stage <- polr(STAGE2 ~  log(GDP) + Polity2, data = Policy_Analysis, Hess = TRUE)

summary(Policy_Stage)
coeftest(Policy_Stage)

#After building the model and interpreting the model, the next step is to evaluate it. 
#The evaluation of the model is conducted on the test dataset. A basic evaluation approach is to compute the confusion matrix and the misclassification error. 

#For predicting
#Compute confusion table and misclassification error - model predicts lo
#predictstage2 = predict(Policy_Stage,Policy_Analysis)
#table(Policy_Analysis$STAGE2, predictstage2)
#mean(as.character(Policy_Analysis$STAGE2) != as.character(predictstage2))


```

#Marine specific variables
```{r}

## Marine Specific Policies ####
SubN_Pol <- Policy_Analysis %>%   ## Subsets marine specific subnational policies
  filter(Mar_subN == 3)
Nat_Pol <- Policy_Analysis %>%   ##subsets marine specific national policies
  filter(Mar_Nat ==3)
Org_Pol <- Policy_Analysis %>% 
  filter(Mar_org ==3)

marine_nat <- full_join(Nat_Pol, SubN_Pol)  #### joins the two together, all marine specific policies
marine_specific <- full_join(marine_nat, Org_Pol)

### Policies that are not marine specific, but include marine explicitly ####
Sub_exp <-Policy_Analysis %>%   ## Subsets marine explicit subnational policies
  filter(Mar_subN == 2)
Nat_exp <-Policy_Analysis %>%   ## Subsets marine explicit subnational policies
  filter(Mar_Nat == 2)
Org_exp <- Policy_Analysis %>% 
  filter(Mar_org == 2)

marine_nat2 <- full_join(Sub_exp, Nat_exp)
marine_explicit <- full_join(marine_nat2, Org_exp)


## Policies that include marine implicitly ###

marine_implicit <- Policy_Analysis %>% 
  filter(Mar_subN == 1 | Mar_Nat == 1 |Mar_supraN == 1 | Mar_org == 1)

Sub_imp <-Policy_Analysis %>%   ## Subsets marine implicit subnational policies
  filter(Mar_subN == 1 )
Nat_imp <-Policy_Analysis %>%   ## Subsets marine implicit national policies
  filter(Mar_Nat == 1)
Supr_imp <- Policy_Analysis %>%   ## Subsets marine implicit supra-national policies
 filter(Mar_supraN == 1)
Mar_Imp <- full_join (Sub_imp, Nat_imp)
marine_implicit2 <- full_join (Mar_Imp, Supr_imp)  ##all marine implicit policies


#as.factor(MarinePol$STAGE2)

#marine_inclusive <- full_join(marine_specific, marine_explicit)  ### Includes marine considered explicitly and implicitly

#All_marine <- full_join(marine_inclusive, marine_specific) ## Include all marine policies, no matter how included

## Policies that don't include marine at all
No_mar <- Policy_Analysis %>%   #Subsets no policies
  filter(Presence_Absence == 0)


```

#Marine Policies from offsets database
```{r}
#load data
offsets_db <- read.csv("C:/Users/uqnshumw/OneDrive - The University of Queensland/Documents/Git/Marine-NNL-database/Offsets by country.csv", comment.char="#")


#Filter db by marine specific policies


#filters by country
specific <- Policy_Analysis %>% 
  filter(marine_mech == "3")


#filters by country (n=36)
specific_explicit <- Policy_Analysis %>% 
  filter(marine_mech == "2" | marine_mech == "3")

explicit <- Policy_Analysis %>% 
  filter(marine_mech == "2")

##Implicit policies
implicit <- Policy_Analysis %>% 
  filter(marine_mech == "1")

none <- Policy_Analysis %>% 
  filter(marine_mech == "0")


##group implicit to all explicit policies - this gives you 90 policies, how many countries though?
#ALL <- offsets_db %>% 
  #filter(Implicit_Explicit == "Explicit"| Implicit_Explicit == "Implicit")

# this subsets by the number of disctinct countries n=71 (added one)
by_country2 <- ALL %>% 
  distinct(Country, .keep_all = FALSE) 

```


#Summary stats for marine policies as tables

```{r}



ggplot(Policy_Analysis, aes(x = marine_mech)) +
  geom_bar(stat = 'count') +
  theme(axis.text.x = element_text(angle = 45, size = 7.5, hjust = 1)) +
  xlab("Policy Type") +
  ylab("Number of countries") +
  labs(fill = "Mine Type")+
  facet_wrap(~, labeller = as_labeller(marine_names))
  

#Makes a vector with mine type names
marine_names <- c('0' = "No policy",
                 '1' = "Marine implicit",
                 '2' = "Marine explicit",
                 '3' = "Marine specific") 

grid.table(for_table)

```

##Subset variables for analysis
```{r}

Var_subset <- Policy_Analysis %>% 
  select(marine_mech, Richness, GDP, EEZ_Protected, OHI, mam_bird, Rents, Polity2)


Offset_subset <- offsets_db %>% 
  select(Country, Region, Marine.Specific, Implicit_Explicit, Focus, Year, Stage)
  

```


#Marine mechanism AOV and T-test
```{r}


Marine_aov <- aov(marine_mech ~ Polity2 + GDP + OHI + Rents + EEZ_Protected + Richness + mam_bird, data = Var_subset)
summary(Marine_aov)

#Tukey Test
summary(aov(marine_mech ~ as.factor(Polity2), Var_subset))
TukeyHSD(aov(marine_mech ~ as.factor(Polity2), Var_subset))

summary(aov(marine_mech ~ as.factor(GDP), Var_subset))
TukeyHSD(aov(marine_mech ~ as.factor(GDP), Var_subset))

summary(aov(marine_mech ~ as.factor(OHI), Var_subset))
TukeyHSD(aov(marine_mech ~ as.factor(OHI), Var_subset))
```


#Plotting

## Marine Specific vs OHI
```{r}

########Plot marine specific policies vs OHI #################
ggplot(data = Policy_Analysis, aes (x=OHI, y = log(GDP)))+
  geom_point(data = specific, aes(x=OHI, y = log(GDP)), size = 2, shape = 19, color = "green") +
  geom_text(data = specific, aes(label= COUNTRY),size = 3.5, color="black", hjust =1, vjust = .5)+
  geom_point(data = implicit, aes(x=OHI, y = log(GDP)), size = 2, color = "red") +
  geom_point(data = none, aes(x=OHI, y = log(GDP)), size = 2, color = "grey50") +
  geom_point(data = explicit,aes(x=OHI, y = log(GDP)), size = 2, color = "blue") +
  #geom_text(aes(label= COUNTRY),size = 3.5, color="black", hjust =1, vjust = .5) +
  xlab("Ocean Health Index") +
  ylab("logGDP") +
  
  #scale_color_manual("Policy Type", limits = c("Marine Explicit", "Marine Implicit", "No Policy", "Marine Specific"), 
                     #values = c("green", "red", "grey50", "blue")) +
  #guides(colour = guide_legend(override.aes = list(pch = c(16,21), fill = c("green", "red", "grey50", "blue"))))+
  theme_classic()


## Polity 2 vs GDP
  
ggplot(data = Policy_Analysis, aes (x=log(GDP), y = Polity2), color = Country)+
  geom_point(data = specific, aes(x=log(GDP), y = Polity2, color = "green"), color = "green", size = 2, shape = 19)+ 
  geom_text(data = specific, aes(label= COUNTRY),size = 3.5, color="black", hjust =1, vjust = 0)+
  geom_point(data = implicit, aes(x=log(GDP), y = Polity2, color = "red"), color = "red", size = 2)+
  geom_point(data = none, aes(x=log(GDP), y = Polity2, color = "grey50"), color = "grey50", size = 2)+
  geom_point(data = explicit, aes(x=log(GDP), y = Polity2, color = "blue"),color = "blue", size = 2)+
  geom_label(x=29, y=-2.5, label = "High capacity, Low implementation", size =3.5, vjust = -1, fill = "grey", color = "white")+
  geom_label(x=29, y=11, label = "High capacity, High implementation", size =3.5, vjust = -1, fill = "grey", color = "white")+
  geom_label(x=24, y= -2.5, label = "Low capacity, Low implementation", size =3.5, vjust = -1, fill = "grey", color = "white")+
  geom_label(x=24, y=11, label = "Low capacity, High implementation", size =3.5, vjust = -1, fill = "grey", color = "white")+
  theme (text = element_text(family = "Arial"))+
  xlab("logGDP") +
  ylab("Polity2") +
  ylim(-10, 13)+
  xlim (22,31)+
  geom_hline (yintercept = 0, color = "black") +
  geom_vline(xintercept = 27, color = "black") +
  
  scale_color_manual("Policy Type", limits = c("Marine Explicit", "Marine Implicit", "No Policy", "Marine Specific"), 
                     values = c("green", "red", "grey50", "blue")) +
  #guides(colour = guide_legend(override.aes = list(pch = c(16,21), fill = c("green", "red", "grey50", "blue"))))+
  theme_classic()


```

#Plot marine specific vs species Richness
```{r}
########Plot marine specific policies vs Richness ################# edited colors so marine explicit and specific are both blue
ggplot(data = Mar_Pol, aes (x=Richness, y = log(GDP)))+
  
  geom_point(data = Mar_Exp, aes(x=Richness, y = log(GDP)), size = 2, shape = 19, color = "blue") +
  geom_text(aes(label= COUNTRY),size = 3.5, color="black", hjust =1, vjust = .5) +
  
  geom_point(data = Mar_Imp2, aes(x=Richness, y = log(GDP)), size = 2, color = "red") +
  
  geom_point(data = No_mar, aes(x=Richness, y = log(GDP)), size = 2, color = "grey50") +
  
  geom_point(data = Mar_Pol,aes(x=Richness, y = log(GDP)), size = 2, color = "blue") +
  geom_text(aes(label= COUNTRY),size = 3.5, color="black", hjust =1, vjust = .5) +
 
  
  
  xlab(" Species Richness") +
  ylab("logGDP") +
  
  scale_color_manual("Policy Type", limits = c("Marine Explicit", "Marine Implicit", "No Policy", "Marine Specific"), 
                     values = c("green", "red", "grey50", "blue")) +
  guides(colour = guide_legend(override.aes = list(pch = c(16,21), fill = c("green", "red", "grey50", "blue"))))+
  theme_minimal()


ggplot(data = Mar_Pol, aes (x=Richness, y = log(GDP)))+
  geom_point(data = Mar_Pol,aes(x=Richness, y = log(GDP)), size = 2, color = "blue") +
  geom_text(aes(label= COUNTRY),size = 2.5, color="black") +
  
  geom_point(data = Mar_Imp2, aes(x=Richness, y = log(GDP)), size = 2, color = "pink") +
  geom_text(aes(label= COUNTRY),size = 2.5, color="black") +
  
  geom_point(data = Mar_Exp, aes(x=Richness, y = log(GDP)), size = 2, color = "blue") +
  geom_text(aes(label= COUNTRY),size = 2.5, color="black") +
  
  geom_point(data = No_mar, aes(x=Richness, y = log(GDP)), size = 2, color = "black") +
  geom_text(aes(label= COUNTRY),size = 2.5, color="black") +
  
  xlab("Richness") +
  ylab("logGDP")+
  
  ##key not working
  guides(color = guide_legend(title = "Policy Type")) +
  theme_classic()

```


##Plotting the effects
```{r}

## this isn't working - getting log(GDP) predictor is not in the model?
library("effects")
Effect(focal.predictors = "log(GDP)",Policy_Stage)
plot(Effect(focal.predictors = "log(GDP)",Policy_Stage))
plot(Effect(focal.predictors = c("log(GDP)", "Polity2)",Policy_Stage)))

###


```


##Plot
```{r}

boxplot(Policy_Analysis$STAGE ~ Policy_Analysis$EEZ_Protected + Policy_Analysis$Polity2 + Policy_Analysis$GDP + Policy_Analysis$OHI, data = Policy_Analysis, main = "Stage vs Variables", xlab="Variables", ylab= "Stage")

boxplot(Policy_Analysis$Polity2 ~ Policy_Analysis$STAGE, data = Policy_Analysis, id.n=TRUE, main = "Polity2 Index vs Stage", xlab="Stage", ylab= "Polity2 score")
```


##plot

```{r}

### GLM of OHI ### Why signigican in Policy model but not here?

OHI_Model <- glm(formula = Policy_Analysis$Presence_Absence ~ Policy_Analysis$OHI, family = binomial, data = Policy_Analysis)
summary (OHI_Model)
plot(OHI_Model)
boxplot(Policy_Analysis$OHI ~ Policy_Analysis$STAGE, data = Policy_Analysis, main = "Stage vs OHI", xlab="stage", ylab= "OHI")

##########
Model2 <- lm(formula = Policy_Analysis$Presence_Absence ~ Policy_Analysis$Polity2 + Policy_Analysis$GDP + Policy_Analysis$NRR + Policy_Analysis$OHI + Policy_Analysis$Land_Protected, data = Policy_Analysis)
summary(Model2)

######
Polity_model <- lm(formula = Policy_Analysis$Presence_Absence ~ Policy_Analysis$Polity2, data = Policy_Analysis)
summary (Polity_model)
plot(Policy_Analysis$Presence_Absence ~ Policy_Analysis$Polity2, data = Policy_Analysis)
abline(Polity_model)

### lm of country vs. % EEZ Protected ####
fit2 <- lm(formula = Policy_Analysis$Presence_Absence ~ Policy_Analysis$EEZ_Protected, data = Policy_Analysis)
summary (fit2)
plot(Policy_Analysis$Presence_Absence ~ Policy_Analysis$EEZ_Protected, data = Policy_Analysis)
abline(fit2)

### plotting interactions ######
Int1 <- lm(formula = Policy_Analysis$Presence_Absence ~ Policy_Analysis$Polity2*Policy_Analysis$OHI, data = Policy_Analysis)
summary(Int1)

Int2 <- lm(formula = Policy_Analysis$Presence_Absence ~ Policy_Analysis$Polity2*Policy_Analysis$Species_risk, data = Policy_Analysis)
summary(Int2)
interaction.plot(Policy_Analysis$Presence_Absence, Policy_Analysis$Polity2, Policy_Analysis$Species_risk)

```



#Plots
##Load packages
```{r}



```


```{r}
#### Boxplot of Presence/Absence vs. Polity 2 - Y axis first then x (response)

names <- c('1' = "Policy present",
           '2' = "Policy absent")

ggplot(Policy_Analysis, x = Presence_Absense, y = Polity2) +
  geom_boxplot()+
  labs(x = "Policy",
       y = "Polity2 Score") +
  theme_minimal()
  
  #facet_wrap(~, labeller = as_labeller(names))

boxplot(Policy_Analysis$Polity2 ~ Policy_Analysis$Presence_Absence, data = Policy_Analysis, main = "Polity2 Index", xlab="Policy", ylab= "Polity2 score") +
  

boxplot(log(Policy_Analysis$GDP) ~ Polity_Analysis$Presence_Absence, data = Policy_Analysis, main = "Presence vs GDP", xlab="Presence", ylab= "log(GDP)")

boxplot(log(Policy_Analysis$EEZ_Protected) ~ Polity_Analysis$Presence_Absence, data = Policy_Analysis, main = "Presence vs EEZ", xlab="Presence", ylab= "log(EEZ)")

boxplot(Policy_Analysis$Richness ~ Policy_Analysis$STAGE, ylim= c(0,1), data = Policy_Analysis, main = "STAGE vs Richness", xlab="Stage", ylab= "Richness")

#############GOOD SAMPLE CODE##############
#ggplot(Var_subset, aes(reorder(GDP,),Mileage,fill=Country))+
# ggplot(tyre, aes(Brands,Mileage,fill=Brands))+ # if you want to leave them alphabetic
  geom_jitter(colour = "dark gray",width=.1) +
  stat_boxplot(geom ='errorbar',width = 0.4) +
  geom_boxplot()+
  labs(title="Boxplot, dotplot and SEM plot of mileage for four brands of tyres", 
       x = "Brands (sorted)",
       y = "Mileage (in thousands)",
       subtitle ="Gray dots=sample data points, Black dot=outlier, Blue dot=mean, Red=99% confidence interval",
       caption = "Data from https://datascienceplus.com/one-way-anova-in-r/") +
  guides(fill=FALSE) +
  stat_summary(fun.data = "mean_cl_normal", colour = "red", size = 1.5, fun.args = list(conf.int=.99)) +
  stat_summary(geom="point", fun.y=mean, color="blue") +
  theme_bw()




### plotting stage vs GDP - cut into quartiles
plot(Policy_Analysis$STAGE ~ log(Policy_Analysis$GDP), data = Policy_Analysis)
grid(2,2)
identify(log(Policy_Analysis$GDP), Policy_Analysis$STAGE, labels = row.names (Policy_Analysis$GI), plot = TRUE, tolerance = .25) #not working


plot(Policy_Analysis$Polity2~ log(Policy_Analysis$GDP), data = Policy_Analysis)
grid(2,2)

##ggplot
library("ggplot2")
library("scales")



#Policy_Analysis$GDP = as.numeric(levels(Policy_Analysis$GDP))[Policy_Analysis$GDP]

Policy_Analysis$Presence_Absence<-as.factor(Policy_Analysis$Presence_Absence) #force group to be a factor
Policy_Analysis$GDP <-as.integer(Policy_Analysis$GDP)

ggplot(data=Policy_Analysis, aes(x=log(GDP), y=Polity2, color = Policy_Analysis$Presence_Absence)) + 
  geom_point(size = 3) +
  xlab("logGDP") +
  ylab("Polity 2 Score") +
  theme_minimal() + xlim(20,31) +
  guides(color = guide_legend(title = "Policy Presence")) +
  geom_hline(data = Policy_Analysis, aes(yintercept = as.numeric(0)), color= "gray") +
  geom_vline(data = Policy_Analysis, aes(xintercept = as.numeric(median(log(Policy_Analysis$GDP))), color = "red")) #code for quartile not working
##+ panel.grid.major = element_line(colour = "firebrick", size = 4) - not working

#geom_vline(xintercept = as.numeric(median(log(Policy_Analysis$GDP))), color = "red"))

#3d Scatter plot

library(scatterplot3d)
attach(Policy_Analysis)
scatterplot3d(Policy_Analysis$STAGE, Policy_Analysis$GDP, Policy_Analysis$Polity2, main = "3D Scatterplot")


```


